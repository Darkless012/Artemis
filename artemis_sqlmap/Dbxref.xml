<?xml version="1.0" encoding="UTF-8" ?> 
 
<!DOCTYPE sqlMap 
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" 
    "http://ibatis.apache.org/dtd/sql-map-2.dtd"> 
 

<sqlMap namespace="Dbxref"> 
 
  <select id="getDbxref" parameterClass="uk.ac.sanger.artemis.chado.ChadoFeature"
                         resultClass="uk.ac.sanger.artemis.chado.Dbxref">
   	SELECT  
	  db.name,
	  dbx.accession,
          f.feature_id
 	FROM $schema$.feature_dbxref dbx_f 
        LEFT JOIN dbxref dbx ON dbx.dbxref_id=dbx_f.dbxref_id
        LEFT JOIN db ON db.db_id=dbx.db_id 
        LEFT JOIN $schema$.feature f ON dbx_f.feature_id=f.feature_id
        <isNotNull property="uniquename"> 
          WHERE f.uniquename=#uniquename#
        </isNotNull>
        <isGreaterThan property="id" compareValue="0">
          WHERE dbx_f.feature_id=$id$
        </isGreaterThan>
        ORDER BY f.type_id,  uniquename
  </select> 
  
  <select id="getDbId" parameterClass="uk.ac.sanger.artemis.chado.Dbxref"
                       resultClass="java.lang.Integer">
    SELECT db_id FROM db WHERE name=#name#
  </select>
  
  <select id="getDbxrefId" parameterClass="uk.ac.sanger.artemis.chado.Dbxref"
                           resultClass="java.lang.Integer">
    SELECT dbxref_id FROM dbxref WHERE accession=#accession#
           AND db_id=db_id;
  </select>
  
  <!-- WRITE BACK -->
  <delete id="deleteFeatureDbxref" parameterClass="uk.ac.sanger.artemis.chado.Dbxref">
     DELETE FROM $schema$.feature_dbxref 
     WHERE dbxref_id=
           (SELECT dbxref_id FROM dbxref WHERE accession=#accession#
            AND db_id=(SELECT db_id FROM db WHERE name=#name#))
     AND feature_id=$feature_id$
  </delete>
  
  <insert id="insertFeatureDbxref" parameterClass="uk.ac.sanger.artemis.chado.Dbxref">
    INSERT INTO $schema$.feature_dbxref 
           (feature_id, dbxref_id, is_current)
           VALUES
           ($feature_id$, $dbxref_id$, $current$)
  </insert>
  
  <insert id="insertDbxref" parameterClass="uk.ac.sanger.artemis.chado.Dbxref">
    INSERT INTO dbxref ( db_id, accession ) 
           VALUES ($db_id$, #accession#)
  </insert>

</sqlMap> 
