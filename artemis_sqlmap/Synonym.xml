<?xml version="1.0" encoding="UTF-8" ?> 
 
<!DOCTYPE sqlMap 
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" 
    "http://ibatis.apache.org/dtd/sql-map-2.dtd"> 
 

<sqlMap namespace="Synonym"> 
  
    <typeAlias alias="FeatureSynonym"
        type="org.gmod.schema.sequence.FeatureSynonym"/>
        
    <typeAlias alias="Synonym"
        type="org.gmod.schema.sequence.Synonym"/>
    
    <typeAlias alias="Feature"
        type="org.gmod.schema.sequence.Feature"/>
        
    <resultMap id="select-all" class="Feature" groupBy="featureId" >
      <result property="featureId" column="feature_id"/>
      <result property="featureSynonyms" 
   	          resultMap="Synonym.select-alias" /> 
    </resultMap>
    
    <resultMap id="select-alias" 
               class="FeatureSynonym">
   	    <result property="feature.featureId" column="feature_id"/>
   	    <result property="pub.pubId" column="pub_id"/>
   	    <result property="current" column="is_current"/>
   	    <result property="internal" column="is_internal"/>
   	    <result property="synonym.synonymId" column="synonym_id"/>
   	    <result property="synonym.name" column="name"/>
   	    <result property="synonym.synonymSgml" column="synonym_sgml"/>
  	    <result property="synonym.cvTerm.cvTermId" column="type_id" />
     </resultMap>
     
     <resultMap id="select-alias-part-lazy" 
               class="FeatureSynonym">
   	    <result property="feature.featureId" column="feature_id"/>
   	    <result property="pub.pubId" column="pub_id"/>
   	    <result property="current" column="is_current"/>
   	    <result property="internal" column="is_internal"/>
   	    <result property="synonym" column="synonym_id" select="getSynonymBySynonymId"/>
     </resultMap>
     
     <resultMap id="select-alias-lazy" 
               class="FeatureSynonym">
   	    <result property="feature.featureId" column="feature_id"/>
   	    <result property="pub.pubId" column="pub_id"/>
   	    <result property="current" column="is_current"/>
   	    <result property="internal" column="is_internal"/>
   	    <result property="synonym" column="synonym_id" select="getSynonymBySynonymId"/>
     </resultMap>
     
     <resultMap id="select-synonym-lazy"
                class="Synonym">
        <result property="synonymId" column="synonym_id"/>
   	    <result property="name" column="name"/>
   	    <result property="synonymSgml" column="synonym_sgml"/>
  	    <result property="cvTerm" column="type_id" select="getCvtermByCvTermId"/>
     </resultMap>
     
     
    <!-- SQL -->
    
    <select id="getAllFeatureSynonymsAsFeature" resultMap="select-all">
      SELECT fs.*, s.name, s.synonym_sgml, s.type_id, s.synonym_id
      FROM feature_synonym fs 
      LEFT JOIN synonym s ON fs.synonym_id=s.synonym_id 
    </select>
             
    
    <select id="getFeatureSynonymsByUniquename" resultMap="select-alias"
            parameterClass="Feature">
      SELECT fs.*, s.name, s.synonym_sgml, s.type_id
      FROM feature_synonym fs 
      LEFT JOIN feature f ON f.feature_id=fs.feature_id 
      LEFT JOIN synonym s ON fs.synonym_id=s.synonym_id 
      <isNotNull property="uniqueName">                        
          WHERE uniquename=#uniqueName#
      </isNotNull>
    </select>
    
	<select id="getFeatureSynonymsBySrcFeatureId" resultMap="select-alias"
            parameterClass="java.lang.Integer">
      SELECT fs.*, s.name, s.synonym_sgml, s.type_id
      FROM feature_synonym fs 
      LEFT JOIN feature f ON f.feature_id=fs.feature_id 
      LEFT JOIN synonym s ON fs.synonym_id=s.synonym_id
      WHERE f.feature_id IN (SELECT feature_id FROM featureloc WHERE srcfeature_id=$value$)
    </select>
	
    <select id="getLazyFeatureSynonymsByUniquename" resultMap="select-alias-part-lazy"
            parameterClass="FeatureSynonym">
      SELECT fs.* 
      FROM feature_synonym fs 
      LEFT JOIN feature f ON f.feature_id=fs.feature_id 
      <isNotNull property="feature.uniqueName">                        
          WHERE uniquename=#feature.uniqueName#
      </isNotNull>
    </select>
	
    
    <select id="getFeatureSynonymsByName" resultMap="select-alias-lazy"
            parameterClass="Synonym">
      SELECT * FROM feature_synonym 
      WHERE
        synonym_id=(SELECT synonym_id FROM synonym WHERE 
        name=#name#) AND is_current
    </select>
    
    <select id="getSynonymByNameAndType" resultMap="select-synonym-lazy"
            parameterClass="Synonym">
      SELECT * FROM synonym WHERE 
        <isNotNull property="name">
          name=#name# AND
        </isNotNull>
        <isNotNull property="cvTerm">
          type_id=$cvTerm.cvTermId$ AND
        </isNotNull> 
        synonym_id > 0
    </select>
    
    <select id="getSynonymBySynonymId" resultMap="select-synonym-lazy">
      SELECT * FROM synonym WHERE synonym_id=#value#
    </select>
   

   
  <!-- WRITE BACK -->
    <delete id="deleteFeatureAlias" parameterClass="FeatureSynonym">
      DELETE FROM feature_synonym WHERE
         synonym_id=$synonym.synonymId$ AND 
         feature_id=(SELECT feature_id FROM feature WHERE  
         uniquename=#feature.uniqueName#)
    </delete>
  
    <insert id="insertFeatureAlias" parameterClass="FeatureSynonym">
      INSERT INTO feature_synonym ( synonym_id, feature_id, pub_id )
      VALUES ( $synonym.synonymId$ , 
              (SELECT feature_id FROM feature WHERE uniquename=#feature.uniqueName#), 
              1)
    </insert>
  
    <delete id="deleteAlias" parameterClass="FeatureSynonym">
      DELETE FROM synonym WHERE synonym_id=$synonym.synonymId$
    </delete>
  
    <insert id="insertAlias" parameterClass="FeatureSynonym">
      INSERT INTO synonym ( name, type_id, synonym_sgml ) 
      VALUES ( #synonym.name#, $synonym.cvTerm.cvTermId$, #synonym.name# )
    </insert>
  
</sqlMap> 