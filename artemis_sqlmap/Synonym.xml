<?xml version="1.0" encoding="UTF-8" ?> 
 
<!DOCTYPE sqlMap 
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" 
    "http://ibatis.apache.org/dtd/sql-map-2.dtd"> 
 

<sqlMap namespace="Synonym"> 
  
    <typeAlias alias="FeatureSynonym"
        type="uk.ac.sanger.artemis.chado.FeatureSynonym"/>
        
    <typeAlias alias="Synonym"
        type="uk.ac.sanger.artemis.chado.Synonym"/>
        
    <resultMap id="select-alias" 
               class="FeatureSynonym">
   	    <result property="feature_id" column="feature_id"/>
   	    <result property="synonym_id" column="synonym_id"/>
   	    <result property="pub_id" column="pub_id"/>
   	    <result property="current" column="is_current"/>
   	    <result property="internal" column="is_internal"/>
   	    <result property="synonym.synonym_id" column="synonym_id"/>
   	    <result property="synonym.name" column="name"/>
   	    <result property="synonym.synonym_sgml" column="synonym_sgml"/>
  	    <result property="synonym.cvterm.cvtermId" column="type_id" />
     </resultMap>
     
     <resultMap id="select-alias-part-lazy" 
               class="FeatureSynonym">
   	    <result property="feature_id" column="feature_id"/>
   	    <result property="synonym_id" column="synonym_id"/>
   	    <result property="pub_id" column="pub_id"/>
   	    <result property="current" column="is_current"/>
   	    <result property="internal" column="is_internal"/>
   	    <result property="synonym" column="synonym_id" select="selectSynonym"/>
     </resultMap>
     
     <resultMap id="select-alias-lazy" 
               class="FeatureSynonym">
   	    <result property="feature_id" column="feature_id"/>
   	    <result property="pub_id" column="pub_id"/>
   	    <result property="current" column="is_current"/>
   	    <result property="internal" column="is_internal"/>
   	    <result property="synonym" column="synonym_id" select="selectSynonym"/>
     </resultMap>
     
     <resultMap id="select-synonym-lazy"
                class="Synonym">
        <result property="synonym_id" column="synonym_id"/>
   	    <result property="name" column="name"/>
   	    <result property="synonym_sgml" column="synonym_sgml"/>
  	    <result property="cvterm" column="type_id" select="selectCvterm"/>
     </resultMap>
     
     
    <!-- SQL -->
     
    <select id="getFeatureSynonymsByUniquename" resultMap="select-alias"
            parameterClass="Feature">
      SELECT fs.*, s.name, s.synonym_sgml, s.type_id
      FROM feature_synonym fs 
      LEFT JOIN feature f ON f.feature_id=fs.feature_id 
      LEFT JOIN synonym s ON fs.synonym_id=s.synonym_id 
      <isNotNull property="uniquename">                        
          WHERE uniquename=#uniquename#
      </isNotNull>
    </select>
    
    <select id="getLazyFeatureSynonymsByUniquename" resultMap="select-alias-part-lazy"
            parameterClass="FeatureSynonym">
      SELECT fs.* 
      FROM feature_synonym fs 
      LEFT JOIN feature f ON f.feature_id=fs.feature_id 
      <isNotNull property="uniquename">                        
          WHERE uniquename=#uniquename#
      </isNotNull>
    </select>
    
    <select id="getFeatureSynonymsByName" resultMap="select-alias-lazy"
            parameterClass="Synonym">
      SELECT * FROM feature_synonym 
      WHERE
        synonym_id=(SELECT synonym_id FROM synonym WHERE 
        name=#name#) AND is_current
    </select>
    
    <select id="getSynonymByNameAndType" resultClass="Synonym"
            parameterClass="Synonym">
      SELECT * FROM synonym WHERE 
        <isNotNull property="name">
          name=#name# AND
        </isNotNull>
        <isNotNull property="cvterm">
          type_id=$cvterm.cvtermId$ AND
        </isNotNull> 
        synonym_id > 0
    </select>
    
    <select id="selectSynonym" resultMap="select-synonym-lazy">
      SELECT * FROM synonym WHERE synonym_id=#value#
    </select>
   

   
  <!-- WRITE BACK -->
    <delete id="deleteFeatureAlias" parameterClass="FeatureSynonym">
      DELETE FROM feature_synonym WHERE
         synonym_id=$synonym_id$ AND 
         feature_id=(SELECT feature_id FROM feature WHERE  
         uniquename=#uniquename#)
    </delete>
  
    <insert id="insertFeatureAlias" parameterClass="FeatureSynonym">
      INSERT INTO feature_synonym ( synonym_id, feature_id, pub_id )
      VALUES ( $synonym_id$ , 
              (SELECT feature_id FROM feature WHERE uniquename=#uniquename#), 
              1)
    </insert>
  
    <delete id="deleteAlias" parameterClass="FeatureSynonym">
      DELETE FROM synonym WHERE synonym_id=$synonym_id$
    </delete>
  
    <insert id="insertAlias" parameterClass="FeatureSynonym">
      INSERT INTO synonym ( name, type_id, synonym_sgml ) 
      VALUES ( #synonym.name#, $synonym.cvterm.cvtermId$, #synonym.name# )
    </insert>
  
</sqlMap> 