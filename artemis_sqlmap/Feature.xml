<?xml version="1.0" encoding="UTF-8" ?> 
 
<!DOCTYPE sqlMap 
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" 
    "http://ibatis.apache.org/dtd/sql-map-2.dtd"> 
 

<sqlMap namespace="Feature"> 
 
    <parameterMap id="schema-cvlist" class="uk.ac.sanger.ibatis.SchemaCVList">
       <parameter property="schema" javaType="java.lang.String"/>
       <parameter property="cvlist" javaType="java.util.List"/>
    </parameterMap> 

    <resultMap id="select-feature-properties-result" class="uk.ac.sanger.ibatis.Feature">
        <result property="timelastmodified" column="timelastmodified"/>
   	<result property="id" column="id"/>
  	<result property="object_id" column="object_id"/>
        <result property="strand" column="strand"/>
        <result property="fmin" column="fmin"/>
        <result property="fmax" column="fmax"/>
        <result property="uniquename" column="uniquename"/>
        <result property="type_id" column="type_id"/>
        <result property="prop_type_id" column="prop_type_id" nullValue="0"/>
        <result property="value" column="value"/>
     </resultMap>

    <resultMap id="select-feature-result" class="uk.ac.sanger.ibatis.Feature">
   	<result property="id" column="id"/>
        <result property="uniquename" column="uniquename"/>
        <result property="name" column="name"/>
        <result property="type_id" column="type_id"/>
        <result property="length" column="length" nullValue="-999" />
  	<result property="srcfeature_id" column="srcfeature_id" nullValue="-999" />
        <result property="fmin" column="fmin" nullValue="-999" />
        <result property="fmax" column="fmax" nullValue="-999" />
        <result property="strand" column="strand" nullValue="0" />
     </resultMap>

     <resultMap id="select-feature-sequence-result" class="uk.ac.sanger.ibatis.Feature">
        <result property="name" column="name"/>
        <result property="residues" column="residues"/>
     </resultMap>
    
     <resultMap id="select-feature-with-residues-result" class="uk.ac.sanger.ibatis.Feature">
        <result property="abbreviation" column="abbreviation"/>
        <result property="name" column="name"/>
        <result property="id" column="feature_id"/>
        <result property="type_id" column="type_id"/>
     </resultMap>


     <!-- get feature name -->
     <select id="getFeatureName" parameterClass="uk.ac.sanger.ibatis.Feature" 
                                 resultClass="java.lang.String"> 
   	SELECT  
	  name
        FROM $schema$.feature WHERE feature_id=$id$
     </select> 

     <select id="getGffLine" parameterClass="uk.ac.sanger.ibatis.Feature" 
                             resultMap="select-feature-properties-result">
        SELECT
          timelastmodified, 
          feature.feature_id AS id, 
          object_id, 
          strand, 
          fmin, 
          fmax, 
          uniquename,
          $schema$.feature.type_id AS type_id,  
          $schema$.featureprop.type_id AS prop_type_id, 
          $schema$.featureprop.value AS value
        FROM  $schema$.featureloc, $schema$.feature
        LEFT JOIN $schema$.feature_relationship
              ON $schema$.feature_relationship.subject_id=$schema$.feature.feature_id
        LEFT JOIN $schema$.featureprop 
              ON $schema$.featureprop.feature_id=$schema$.feature.feature_id
        WHERE
            <dynamic>
             <isGreaterThan property="id" compareValue="0"> 
               srcfeature_id=$id$ AND
             </isGreaterThan>
             <isNotNull property="uniquename">                        
               uniquename=#uniquename# AND
             </isNotNull>
           </dynamic>
           $schema$.featureloc.feature_id=$schema$.feature.feature_id
           AND ($schema$.featureloc.rank=$schema$.feature_relationship.rank OR 
                $schema$.feature_relationship.rank IS NULL)
        ORDER BY $schema$.feature.type_id,  uniquename
     </select>
 
    <select id="getSequence" parameterClass="uk.ac.sanger.ibatis.Feature" 
                             resultMap="select-feature-sequence-result">
       SELECT
         name, 
         residues 
       FROM $schema$.feature 
       WHERE feature_id=$id$
    </select>

    <select id="getSchema" resultClass="java.lang.String">
       SELECT schema_name FROM information_schema.schemata WHERE schema_name=schema_owner
         ORDER BY schema_name
    </select>

    <select id="getResidueType" parameterClass="java.lang.String" resultClass="java.lang.Long">
       SELECT DISTINCT type_id 
       FROM $value$.feature 
       WHERE residues notnull
    </select>


    <select id="getSchemaResidueFeatures" parameterMap="schema-cvlist"
            resultMap="select-feature-with-residues-result">
       SELECT
         abbreviation,
         name,
         feature_id,
         type_id
       FROM organism, $schema$.feature WHERE
         organism.organism_id=$schema$.feature.organism_id AND
         residues notnull
         <iterate prepend="AND" property="cvlist" conjunction="OR" open="(" close=")">
           type_id=#cvlist[]#
         </iterate>
       ORDER BY abbreviation
    </select>

    <select id="getFeature" resultMap ="select-feature-result" parameterClass="uk.ac.sanger.ibatis.Feature">
	 SELECT
	 	$schema$.feature.feature_id AS id,
	 	uniquename,
		name,
	 	$schema$.feature.type_id AS type_id,
		seqlen AS length,
	 	srcfeature_id,
	 	fmin,
	 	fmax,
	 	strand
	 FROM $schema$.feature
	 LEFT JOIN $schema$.featureloc
	 	ON $schema$.feature.feature_id=$schema$.featureloc.feature_id
	 WHERE
	 	<dynamic>
             <isGreaterThan property="id" compareValue="0"> 
               $schema$.feature.feature_id=$id$ AND
             </isGreaterThan>
	 		<isNotNull property="uniquename">                        
               uniquename=#uniquename# AND
             </isNotNull>
             <isGreaterThan property="type_id" compareValue="0"> 
               $schema$.feature.type_id=$type_id$ AND
             </isGreaterThan>
         </dynamic>
         $schema$.feature.feature_id > 0
    </select>
</sqlMap> 
