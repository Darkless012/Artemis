<?xml version="1.0" encoding="UTF-8" ?> 
 
<!DOCTYPE sqlMap 
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" 
    "http://ibatis.apache.org/dtd/sql-map-2.dtd"> 
 

<sqlMap namespace="Feature"> 
 
     <typeAlias alias="ChadoFeature"
        type="uk.ac.sanger.artemis.chado.ChadoFeature"/>
        
     <typeAlias alias="ChadoTransaction"
        type="uk.ac.sanger.artemis.chado.ChadoTransaction"/>
     
    <parameterMap id="schema-cvlist" 
                  class="uk.ac.sanger.artemis.chado.SchemaCVList">
       <parameter property="schema" javaType="java.lang.String"/>
       <parameter property="cvlist" javaType="java.util.List"/>
    </parameterMap> 

    <resultMap id="select-feature-properties-result" 
               class="ChadoFeature">
        <result property="timelastmodified" column="timelastmodified"/>
   	    <result property="id" column="id"/>
  	    <result property="feature_relationship.object_id" column="object_id"/>
        <result property="featureloc.strand" column="strand" nullValue="0"/>
        <result property="featureloc.fmin" column="fmin" nullValue="-1"/>
        <result property="featureloc.fmax" column="fmax" nullValue="0"/>
        <result property="featureloc.phase" column="phase" nullValue="10"/>
        <result property="uniquename" column="uniquename"/>
        <result property="cvterm.id" column="type_id"/>
        <result property="featureprop.cvterm.id" column="prop_type_id" nullValue="0"/>
        <result property="featureprop.value" column="value"/>
     </resultMap>

    <resultMap id="select-feature-result" 
               class="ChadoFeature">     
        <result property="schema" column="schema" />  
        <result property="timelastmodified" column="timelastmodified"/>
   	    <result property="id" column="id"/>
        <result property="uniquename" column="uniquename"/>
        <result property="name" column="name"/>
        <result property="length" column="length" nullValue="-999" />
  	    <result property="featureloc.srcfeature_id" column="srcfeature_id" nullValue="-999" />
        <result property="featureloc.fmin" column="fmin" nullValue="-999" />
        <result property="featureloc.fmax" column="fmax" nullValue="-999" />
        <result property="featureloc.strand" column="strand" nullValue="0" />
        <result property="cvterm" column="type_id" select="selectCvterm" />
        <result property="featurepropList" column="{schema=schema, feature_id=id}" 
                                           select="selectFeatureProp" />                            
        <!-- 
        <result property="featureprop.cvterm" column="prop_type_id" select="selectCvterm" />
        <result property="featureprop.value" column="value" />
        <result property="featureprop.rank" column="rank" />
        -->
        <result property="organism" column="organism_id" select="selectOrganism" />
     </resultMap>
     
     <resultMap id="select-feature-sequence-result" 
                class="ChadoFeature">
        <result property="name" column="name"/>
        <result property="residues" column="residues"/>
     </resultMap>
    
     <resultMap id="select-feature-with-residues-result" 
                class="ChadoFeature">
        <result property="organism.abbreviation" column="abbreviation"/>
        <result property="name" column="name"/>
        <result property="id" column="feature_id"/>
        <result property="cvterm.id" column="type_id"/>
     </resultMap>

     <resultMap id="select-product-result" 
                class="uk.ac.sanger.artemis.chado.ChadoFeatureProp">
        <result property="value" column="value" />
        <result property="rank" column="rank" />
        <result property="cvterm" column="type_id" select="selectCvterm" />
     </resultMap>
     
     <select id="selectOrganism" resultClass="uk.ac.sanger.artemis.chado.ChadoOrganism"> 
       SELECT organism_id AS id, abbreviation, genus, species, common_name, comment 
       FROM organism
       WHERE organism_id=#value# 
     </select> 
     
     <select id="selectFeatureProp" resultMap="select-product-result">
       SELECT type_id, value, rank 
       FROM $schema$.featureprop
       WHERE feature_id=#feature_id#
     </select>
     
     <!-- get feature name -->
     <select id="getFeatureName" parameterClass="ChadoFeature" 
                                 resultClass="java.lang.String"> 
   	   SELECT name
       FROM $schema$.feature WHERE feature_id=$id$
     </select> 

     <!-- get feature id -->
     <select id="getFeatureID" parameterClass="ChadoTransaction"
                               resultClass="java.lang.Integer">
        SELECT feature_id FROM $schema$.feature WHERE
          <iterate property="uniquename" conjunction="OR">
            $schema$.feature.uniquename='$uniquename[]$'
          </iterate>
     </select>

     <select id="getGffLine" parameterClass="ChadoFeature" 
                             resultMap="select-feature-properties-result">
        SELECT
          timelastmodified, 
          f.feature_id AS id, 
          object_id, 
          fl.strand, 
          fmin, 
          fmax, 
          uniquename,
          f.type_id,  
          fp.type_id AS prop_type_id, 
          fp.value,
          fl.phase
        FROM  $schema$.feature f
        LEFT JOIN $schema$.feature_relationship fr ON fr.subject_id = f.feature_id
        LEFT JOIN $schema$.featureprop fp          ON fp.feature_id = f.feature_id
        LEFT JOIN $schema$.featureloc fl           ON f.feature_id  = fl.feature_id
        WHERE
            <dynamic>
             <isGreaterThan property="id" compareValue="0"> 
               srcfeature_id=$id$ AND
             </isGreaterThan>
             <isNotNull property="uniquename">                        
               uniquename LIKE #uniquename# AND
             </isNotNull>
           </dynamic>
           (fl.rank=fr.rank OR fr.rank IS NULL)
        ORDER BY f.type_id,  uniquename
     </select>
 
    <select id="getSequence" parameterClass="ChadoFeature" 
                             resultMap="select-feature-sequence-result">
       SELECT
         name, 
         residues 
       FROM $schema$.feature 
       WHERE feature_id=$id$
    </select>

    <select id="getSchema" resultClass="java.lang.String">
       SELECT schema_name FROM information_schema.schemata WHERE schema_name=schema_owner
         ORDER BY schema_name
    </select>

    <select id="getResidueType" parameterClass="java.lang.String" 
            resultClass="java.lang.Long">
       SELECT DISTINCT type_id 
       FROM $value$.feature 
       WHERE residues notnull
    </select>


    <select id="getSchemaResidueFeatures" parameterMap="schema-cvlist"
            resultMap="select-feature-with-residues-result">
       SELECT
         abbreviation,
         name,
         feature_id,
         type_id
       FROM organism, $schema$.feature WHERE
         organism.organism_id=$schema$.feature.organism_id AND
         residues notnull
         <iterate prepend="AND" property="cvlist" conjunction="OR" open="(" close=")">
           type_id=#cvlist[]#
         </iterate>
       ORDER BY abbreviation
    </select>

    <select id="getFeature" resultMap ="select-feature-result" 
                            parameterClass="ChadoFeature">
	 SELECT
	    #schema# AS schema,
	    timelastmodified,
	 	f.feature_id AS id,
	 	uniquename,
	 	organism_id,
		name,
	 	f.type_id,
		seqlen AS length,
	 	srcfeature_id,
	 	fmin,
	 	fmax,
	 	strand
	 	<!-- 
	 	,fp.type_id AS prop_type_id
	 	,fp.value
	 	,fp.rank
	 	-->
	 FROM $schema$.feature f
	 LEFT JOIN $schema$.featureloc     ON f.feature_id=$schema$.featureloc.feature_id
	 <!-- 
	 LEFT JOIN $schema$.featureprop fp ON fp.feature_id = f.feature_id
	 -->
	 WHERE
	 <dynamic>
             <isGreaterThan property="id" compareValue="0"> 
               f.feature_id=$id$ AND
             </isGreaterThan>
             <isNotNull property="uniquename">                        
               uniquename LIKE #uniquename# AND
             </isNotNull>
             <isGreaterThan property="cvterm.id" compareValue="0"> 
               $schema$.feature.type_id=$cvterm.id$ AND
             </isGreaterThan>
         </dynamic>
         f.feature_id > 0
    </select>

    <select id="getOrganismID" resultClass="java.lang.Integer" 
            parameterClass="ChadoFeature">
      SELECT organism_id FROM $schema$.feature f WHERE
             f.feature_id=$featureloc.srcfeature_id$
    </select>

    <select id="getTimeLastModified" resultClass="java.sql.Timestamp"
            parameterClass="ChadoFeature">
      SELECT timelastmodified FROM $schema$.feature f WHERE
             f.uniquename=#uniquename#
    </select>
    
    <select id="currval" resultClass="java.lang.Integer" 
            parameterClass="java.lang.String">
      SELECT currval('$value$')
    </select>



    <!--  WRITE BACK METHODS -->
    <update id="updateAttributes" 
            parameterClass="ChadoTransaction">
      UPDATE $schema$.$chadoTable$
      SET
      <iterate property="properties" conjunction=",">
         $properties[]$
      </iterate>

      <isNotEqual property="chadoTable" compareValue="feature">
        FROM $schema$.feature
      </isNotEqual>

      WHERE
           $schema$.feature.feature_id=$schema$.$chadoTable$.feature_id AND (
      <iterate property="uniquename" conjunction="OR">
         $schema$.feature.uniquename='$uniquename[]$'
      </iterate>
      )
      <dynamic>
        <isNotNull property="constraint">
           <iterate prepend="AND" property="constraint" conjunction="AND">
             $constraint[]$
           </iterate>
        </isNotNull>
      </dynamic>
    </update>

    <insert id="insertAttributes" 
            parameterClass="ChadoTransaction">
      INSERT INTO  $schema$.$chadoTable$
      ( 
        feature_id 
        <iterate prepend="," property="propertiesName" conjunction="," >
          $propertiesName[]$
        </iterate>
      ) VALUES
      (
        $feature_id$
        <iterate prepend="," property="propertiesValue" conjunction="," >
          $propertiesValue[]$
        </iterate>
      )
    </insert>

    <delete id="deleteAttributes" 
            parameterClass="ChadoTransaction">
      DELETE FROM $schema$.$chadoTable$
      WHERE
        <iterate property="constraint" conjunction="AND">
          $constraint[]$
        </iterate>
        AND
        feature_id=$feature_id$
    </delete>

    <insert id="insertFeature" 
            parameterClass="ChadoFeature">
      INSERT INTO  $schema$.feature 
        ( feature_id, organism_id, name, uniquename, type_id )
      VALUES
        ( nextval('$schema$.feature_feature_id_seq'),
          $organism.id$,
          #name#,
          #uniquename#,
          $cvterm.id$ )
    </insert>

    <insert id="insertFeatureLoc" 
            parameterClass="ChadoFeature">
      INSERT INTO  $schema$.featureloc
        ( featureloc_id, feature_id, srcfeature_id, fmin, fmax, strand, phase )
      VALUES
        ( nextval('$schema$.featureloc_featureloc_id_seq'),
          $id$,
          $featureloc.srcfeature_id$,
          $featureloc.fmin$,
          $featureloc.fmax$,
          $featureloc.strand$,
          $featureloc.phase$ )
    </insert>

   <delete id="deleteFeature" 
           parameterClass="ChadoFeature">
      DELETE FROM $schema$.feature
      WHERE uniquename=#uniquename#
    </delete>

</sqlMap> 
